<div class="bill-container">
    <div class="bill-card">
        <div class="bill-header">
            <h1 class="shop-name">N&Wool Flowers</h1>
            <p class="bill-title">X√ÅC NH·∫¨N ƒê∆†N H√ÄNG</p>
            <div class="bill-date" id="current-date"></div>
        </div>

        <div class="bill-body">
            <div class="bill-section">
                <h3 class="section-title"><i class="fas fa-truck"></i> Th√¥ng Tin Nh·∫≠n H√†ng</h3>
                <div class="input-group">
                    <input type="text" id="customer-name" placeholder="H·ªç v√† t√™n ng∆∞·ªùi nh·∫≠n" required>

                    <input type="tel" id="customer-phone"
                           placeholder="S·ªë ƒëi·ªán tho·∫°i (10 ch·ªØ s·ªë)"
                           maxlength="10"
                           oninput="this.value = this.value.replace(/[^0-9]/g, '');"
                           required>

                    <textarea id="customer-address" placeholder="ƒê·ªãa ch·ªâ giao h√†ng chi ti·∫øt" rows="2" required></textarea>
                </div>
            </div>

            <div class="bill-section">
                <h3 class="section-title"><i class="fas fa-shopping-basket"></i> Danh S√°ch S·∫£n Ph·∫©m</h3>
                <table class="bill-table">
                    <thead>
                    <tr>
                        <th>S·∫£n ph·∫©m</th>
                        <th>SL</th>
                        <th class="text-right">Th√†nh ti·ªÅn</th>
                    </tr>
                    </thead>
                    <tbody id="bill-items">
                    </tbody>
                </table>
            </div>

            <div class="bill-section payment-section">
                <h3 class="section-title"><i class="fas fa-credit-card"></i> Ph∆∞∆°ng Th·ª©c Thanh To√°n</h3>
                <div class="payment-method">
                    <input type="radio" id="cod" name="payment" checked>
                    <label for="cod">
                        <img src="https://cdn-icons-png.flaticon.com/512/6491/6491490.png" width="25">
                        Thanh to√°n khi nh·∫≠n h√†ng (COD)
                    </label>
                </div>
            </div>

            <div class="bill-divider"></div>

            <div class="bill-summary">
                <div class="summary-line">
                    <span>T·ªïng ti·ªÅn h√†ng:</span>
                    <span id="bill-subtotal">0‚Ç´</span>
                </div>
                <div class="summary-line">
                    <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                    <span class="free-ship">Mi·ªÖn ph√≠</span>
                </div>
                <div class="summary-line total">
                    <span>T·ªîNG THANH TO√ÅN:</span>
                    <span id="bill-total-final">0‚Ç´</span>
                </div>
            </div>
        </div>

        <div class="bill-footer">
            <p>Vui l√≤ng ki·ªÉm tra k·ªπ th√¥ng tin tr∆∞·ªõc khi ƒë·∫∑t h√†ng!</p>
            <div class="bill-actions">
                <button class="btn-confirm" id="btn-complete-order">HO√ÄN T·∫§T ƒê·∫∂T H√ÄNG</button>
                <button class="btn-cancel" onclick="window.location.href='/giohang'">Quay l·∫°i gi·ªè h√†ng</button>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<script>
    // 1. C·∫≠p nh·∫≠t ng√†y th√°ng hi·ªÉn th·ªã tr√™n h√≥a ƒë∆°n
    document.getElementById('current-date').innerText = "Ng√†y: " + new Date().toLocaleDateString('vi-VN');

    // 2. X√°c ƒë·ªãnh User v√† Ch√¨a kh√≥a gi·ªè h√†ng
    const userId = "{{user._id}}";
    const cartKey = userId ? `cart_${userId}` : 'cart_guest';

    // L·∫•y d·ªØ li·ªáu t·ª´ localStorage theo ID ng∆∞·ªùi d√πng
    let cart = JSON.parse(localStorage.getItem(cartKey)) || [];

    // 3. H√†m hi·ªÉn th·ªã danh s√°ch s·∫£n ph·∫©m l√™n b·∫£ng
    function renderBill() {
        const billItems = document.getElementById("bill-items");

        if (cart.length === 0) {
            alert("Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng!");
            window.location.href = '/shop';
            return;
        }

        let html = "";
        let total = 0;
        cart.forEach((item) => {
            const sub = item.price * item.qty;
            total += sub;
            html += `
            <tr>
                <td><strong>${item.name}</strong></td>
                <td>x${item.qty}</td>
                <td class="text-right">${sub.toLocaleString()}‚Ç´</td>
            </tr>`;
        });

        billItems.innerHTML = html;
        document.getElementById('bill-subtotal').innerText = total.toLocaleString() + '‚Ç´';
        document.getElementById('bill-total-final').innerText = total.toLocaleString() + '‚Ç´';
    }

    // 4. X·ª≠ l√Ω n√∫t HO√ÄN T·∫§T ƒê·∫∂T H√ÄNG
    document.getElementById('btn-complete-order').addEventListener('click', async (e) => {
        e.preventDefault();

        // L·∫•y d·ªØ li·ªáu v√† x√≥a kho·∫£ng tr·∫Øng th·ª´a
        const name = document.getElementById('customer-name').value.trim();
        const phone = document.getElementById('customer-phone').value.trim();
        const address = document.getElementById('customer-address').value.trim();

        // KI·ªÇM TRA 1: D·ªØ li·ªáu tr·ªëng
        if (!name || !phone || !address) {
            alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin giao h√†ng!");
            return;
        }

        // KI·ªÇM TRA 2: S·ªë ƒëi·ªán tho·∫°i ph·∫£i ƒë·ªß 10 s·ªë
        const phoneRegex = /^[0-9]{10}$/;
        if (!phoneRegex.test(phone)) {
            alert("S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá! Vui l√≤ng nh·∫≠p ƒë√∫ng 10 ch·ªØ s·ªë.");
            document.getElementById('customer-phone').focus();
            return;
        }

        const totalAmount = cart.reduce((sum, item) => sum + item.price * item.qty, 0);

        const orderData = {
            user: { name, phone, address },
            items: cart,
            total: totalAmount
        };

        // Hi·ªáu ·ª©ng ch·ªù khi ƒëang g·ª≠i d·ªØ li·ªáu
        const btn = document.getElementById('btn-complete-order');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';

        try {
            const response = await fetch('/thanhtoan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });

            const result = await response.json();

            if (result.success) {
                alert("üì¶ ƒê·∫∑t h√†ng th√†nh c√¥ng! C·∫£m ∆°n b·∫°n ƒë√£ ·ªßng h·ªô shop.");

                // X√≥a gi·ªè h√†ng c·ªßa user sau khi ƒë·∫∑t xong
                localStorage.removeItem(cartKey);

                window.location.href = '/shop';
            } else {
                alert(result.message || "L·ªói t·∫°o ƒë∆°n h√†ng");
                btn.disabled = false;
                btn.innerHTML = "HO√ÄN T·∫§T ƒê·∫∂T H√ÄNG";
            }
        } catch (err) {
            console.error(err);
            alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i sau!");
            btn.disabled = false;
            btn.innerHTML = "HO√ÄN T·∫§T ƒê·∫∂T H√ÄNG";
        }
    });

    // Kh·ªüi ch·∫°y khi v√†o trang
    renderBill();
</script>